浏览器工作流程【从输入URL到页面展示】

- 导航
- 用户输入
  1. 用户在地址栏按下回车，检查输入（关键字Or符合URL规则），组装完整URL
  2. 回车前，当前页面执行 `onbeforeunload`事件
  3. 浏览器进入加载状态

- URL请求

  1. 浏览器进程通过IPC把URL请求发送至网络进程
  2. 查找资源缓存
  3. DNS解析
  4. 进入TCP队列，浏览器对单个域名的连接数量限制
  5. 创建TCP连接（三次握手）
  6. HTTPS建立TLS连接
  7. 发送HTTP请求
  8. 接收请求（响应行【协议，状态码，状态消息】、响应头、响应体等）
     - 状态码301/302，根据响应头中的Location重定向
     - 状态码200，根据响应头中的Content-Type决定如何响应

- 准备渲染进程

  1. 根据是否是同一沾点（相同的协议，相同的根域名），决定是否复用渲染进程

- 提交文档

  1. 浏览器进程接受到网络进程的响应头数据，向渲染进程发送【提交文档】消息
  2. 渲染进程收到【提交文档】消息后，与网络进程建立传输数据【管道】
  3. 传输完成后，渲染进程返回【确认提交】消息给浏览器进程
  4. 浏览器接收【确认提交后】消息后，移除旧文档、更新界面、地址栏，导航历史状态等
  5. 此时标识浏览器加载状态的小圆圈，从此前URL网络请求时的逆时针旋转，变成顺时针旋转（进入渲染阶段）

- 渲染

  - 渲染流水线

  - 构建DOM树

    1. 输入：HTML文档
    2. 处理：HTML解析器解析
    3. 输出：DOM数据解构

  - 样式计算

    1. 输入：CSS文本
    2. 处理：属性值标准化，每个节点具体样式（继承、层叠）
    3. 输出：`styleSheets`(CSSOM)

  - 布局（DOM树中元素的计划位置）

    1. DOM& CSSOM合成渲染树
    2. 布局树（DOM树中的可见元素）
    3. 布局计算

  - 分层

    1. 特定节点生成专用图层，生成一颗图层树（层叠上下文，Clip，类似`PhotoShop`里的图层）
    2. 拥有层叠上下文属性（明确定位属性、透明属性、CSS滤镜、z-Index等）的元素会创建单独图层
    3. 没有图层的DOM 节点属于父节点图层
    4. 需要裁减的地方也会创建图层（出现滚动条为裁减）。

  - 绘制指令

    1. 输入：图层树
    2. 渲染引擎对图层树中每个图层进行绘制
    3. 拆分成绘制指令，生成绘制列表，提交到合成线程
    4. 输出：绘制列表

  - 分块

    1. 合成线程会将较大、较长的图层（一屏显示不完，大部分不在视口内）划分为图块（title,256\*256, 512\*512）

  - 光栅化

    1. 在光栅化线程池中，将视口附近的图块优先生成位图（栅格化执行该操作）
    2. 快速栅格化：GPU加速，生成位图（GPU进程）

  - 合成绘制

    1. 绘制图块命令-----`DrawQuad`,提交给浏览器进程
    2. 浏览器进程的viz组件，根据`DrawQuad`命令，绘制在屏幕上

    